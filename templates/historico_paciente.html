{% extends "base.html" %}

{% block content %}
<div class="content-header">
    <h1><i class="fas fa-history"></i> Histórico por Paciente</h1>
</div>

<div class="card">
    <form method="POST" action="{{ url_for('historico_paciente') }}">
        <div class="form-group">
            <label for="paciente_id">Selecione o Paciente:</label>
            <select id="paciente_id" name="paciente_id" class="form-control" required onchange="this.form.submit()">
                <option value="">Selecione
                </option>
                {% for paciente in pacientes_list %}
                <option value="{{ paciente.id }}" {% if paciente_encontrado and paciente.id == paciente_encontrado.id %}selected{% endif %}>
                    {{ paciente.nome }} (CPF: {{ paciente.cpf }})
                </option>
                {% endfor %}
            </select>
        </div>
    </form>
</div>

{% if paciente_encontrado %}
    <div class="card card-info">
        <h2 style="margin-top: 0; color: var(--cor-primaria);">Detalhes do Paciente</h2>
        <p><strong>Nome:</strong> {{ paciente_encontrado.nome }}</p>
        <p><strong>CPF:</strong> {{ paciente_encontrado.cpf }}</p>
        <p><strong>Telefone:</strong> {{ paciente_encontrado.telefone }}</p>
        <p><strong>Histórico Básico:</strong> {{ paciente_encontrado.historico_basico or 'N/A' }}</p>
    </div>

    <div class="card">
        <h2>Histórico de Consultas e Atendimentos</h2>
        {% if historico %}
            {% for registro in historico %}
                <div style="border: 1px solid var(--cor-borda); padding: 15px; margin-bottom: 15px; border-radius: 4px; background-color: #f8f8f8;">

                    {# CORREÇÃO APLICADA AQUI #}
                    <p style="font-weight: bold; margin-bottom: 5px;">Data/Hora: {{ registro.data.strftime('%d/%m/%Y') }} às {{ format_timedelta(registro.hora) }}</p>

                    <p><strong>Tipo:</strong> {{ registro.tipo_consulta }} (Status: <span style="font-weight: bold; color: {% if registro.status == 'REALIZADA' %}var(--cor-secundaria){% elif registro.status == 'AGENDADA' %}var(--cor-primaria){% else %}#dc3545{% endif %};">{{ registro.status }}</span>)</p>

                    <p><strong>Agendado/Atendido Por:</strong> {{ registro.atendente|default('N/A') }}</p>

                    {% if registro.evolucao %}
                        <div style="margin-top: 10px; padding: 10px; border-top: 1px dashed #ccc;">
                            <p style="font-weight: bold;">Evolução/Atendimento Registrado:</p>
                            <p>{{ registro.evolucao }}</p>
                        </div>
                    {% elif registro.status == 'REALIZADA' %}
                        <div class="alert alert-warning" style="margin-top: 10px; padding: 10px;">
                            Consulta marcada como REALIZADA, mas o Registro de Atendimento (Evolução) está pendente.
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info">Nenhum histórico de consulta encontrado para este paciente.</div>
        {% endif %}
    </div>

{% elif request.method == 'POST' %}
    <div class="alert alert-danger">Paciente não encontrado ou erro na busca.</div>
{% endif %}

{% endblock %}